# Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Background Queue (SMS & Email)

> **ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯**: Ú˜Ø§Ù†ÙˆÛŒÙ‡ 2026  
> **Ù†Ø³Ø®Ù‡**: 2.0  
> **ÙˆØ¶Ø¹ÛŒØª**: âœ… Production-Ready

---

## ğŸ“‹ ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨

1. [Ù…Ù‚Ø¯Ù…Ù‡](#Ù…Ù‚Ø¯Ù…Ù‡)
2. [Ù…Ø´Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡](#Ù…Ø´Ú©Ù„-Ø§ÙˆÙ„ÛŒÙ‡)
3. [Ø±Ø§Ù‡â€ŒØ­Ù„ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡](#Ø±Ø§Ù‡-Ø­Ù„-Ù¾ÛŒØ§Ø¯Ù‡-Ø³Ø§Ø²ÛŒ-Ø´Ø¯Ù‡)
4. [Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…](#Ù…Ø¹Ù…Ø§Ø±ÛŒ-Ø³ÛŒØ³ØªÙ…)
5. [ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡](#ÙØ§ÛŒÙ„-Ù‡Ø§ÛŒ-Ø§ÛŒØ¬Ø§Ø¯-Ø´Ø¯Ù‡)
6. [ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡](#ØªØºÛŒÛŒØ±Ø§Øª-Ø§Ø¹Ù…Ø§Ù„-Ø´Ø¯Ù‡)
7. [Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡](#Ù†Ø­ÙˆÙ‡-Ø§Ø³ØªÙØ§Ø¯Ù‡)
8. [Ù…Ø²Ø§ÛŒØ§ Ùˆ Ù…Ø¹Ø§ÛŒØ¨](#Ù…Ø²Ø§ÛŒØ§-Ùˆ-Ù…Ø¹Ø§ÛŒØ¨)
9. [ØªØ³Øª Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ](#ØªØ³Øª-Ùˆ-Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ)
10. [Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ](#Ù…Ø´Ú©Ù„Ø§Øª-Ø§Ø­ØªÙ…Ø§Ù„ÛŒ)

---

## Ù…Ù‚Ø¯Ù…Ù‡

Ø§ÛŒÙ† Ø³Ù†Ø¯ ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„ÛŒ Ø§Ø² Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ **Background Queue** Ø¨Ø±Ø§ÛŒ SMS Ùˆ Email Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ IdentityCoreCustomization Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ù„Ø§Ú© Ø´Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú© Ùˆ Ø§ÛŒÙ…ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.

### Ø§Ù‡Ø¯Ø§Ù Ø§ØµÙ„ÛŒ

- âœ… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ù„Ø§Ú© Ø´Ø¯Ù† HTTP Request Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ SMS Ùˆ Email
- âœ… Ø¨Ù‡Ø¨ÙˆØ¯ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹â€ŒØªØ±)
- âœ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ØªØ± Ø®Ø·Ø§Ù‡Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„
- âœ… Ù‚Ø§Ø¨Ù„ÛŒØª retry Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØµÙ
- âœ… Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø§Ø² Ù…Ù†Ø·Ù‚ Ú©Ù†ØªØ±Ù„Ø±
- âœ… ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ø³Ø±ÙˆÛŒØ³ (SMS & Email)

---

## Ù…Ø´Ú©Ù„ Ø§ÙˆÙ„ÛŒÙ‡

### Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ (Blocking)

```csharp
// âŒ Ù…Ø´Ú©Ù„: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†Ø¯
await _emailSender.SendEmailAsync(email, subject, body);
await smsService.SendSms(text, phone);
// Ù…Ù…Ú©Ù† Ø§Ø³Øª 2-10 Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯
return RedirectToAction("NextPage");
```

### Ù…Ø´Ú©Ù„Ø§Øª:

1. **â±ï¸ ØªØ£Ø®ÛŒØ± Ø¯Ø± Ù¾Ø§Ø³Ø®**: Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†Ø¯ (2-10 Ø«Ø§Ù†ÛŒÙ‡)
2. **ğŸ”´ Ù†Ù‚Ø·Ù‡ Ø´Ú©Ø³Øª**: Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ø®Ø±Ø§Ø¨ Ø¨Ø§Ø´Ø¯ØŒ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª fail Ù…ÛŒâ€ŒØ´ÙˆØ¯
3. **ğŸ“‰ Ú©Ø§Ù‡Ø´ Performance**: threadâ€ŒÙ‡Ø§ Ù…Ù†ØªØ¸Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯
4. **âŒ Ø¹Ø¯Ù… Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§**: Ø®Ø·Ø§Ù‡Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
5. **ğŸš« Ø¹Ø¯Ù… Ø§Ù…Ú©Ø§Ù† Retry**: Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ fail Ú©Ù†Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯

---

## Ø±Ø§Ù‡â€ŒØ­Ù„ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡

### Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú©Ù„ÛŒ (ÛŒÚ©Ø³Ø§Ù† Ø¨Ø±Ø§ÛŒ SMS Ùˆ Email)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Queue() (ÙÙˆØ±ÛŒ - Ø¨Ø¯ÙˆÙ† await)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Background      â”‚
â”‚ Queue (Channel) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ DequeueAsync()
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Background      â”‚
â”‚ Service (Hosted)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Ø¨Ø§ IServiceScopeFactory
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SMS / Email    â”‚
â”‚  Service        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…

### 1. Background SMS Queue

#### Interface:
```csharp
public interface IBackgroundSmsQueue
{
    void QueueSms(string smsText, string receipentPhone);
    void QueueSms(string smsText, List<string> receipentPhones);
    Task<(string SmsText, List<string> Phones)> DequeueAsync(CancellationToken ct);
}
```

#### Implementation:
```csharp
public class BackgroundSmsQueue : IBackgroundSmsQueue
{
    private readonly Channel<(string SmsText, List<string> Phones)> _queue;

    public BackgroundSmsQueue(int capacity = 100)
    {
        var options = new BoundedChannelOptions(capacity)
        {
            FullMode = BoundedChannelFullMode.Wait
        };
        _queue = Channel.CreateBounded<(string, List<string>)>(options);
    }
}
```

### 2. Background Email Queue

#### Interface:
```csharp
public interface IBackgroundEmailQueue
{
    void QueueEmail(string email, string subject, string htmlMessage);
    Task<(string Email, string Subject, string HtmlMessage)> DequeueAsync(CancellationToken ct);
}
```

#### Implementation:
```csharp
public class BackgroundEmailQueue : IBackgroundEmailQueue
{
    private readonly Channel<(string Email, string Subject, string HtmlMessage)> _queue;

    public BackgroundEmailQueue(int capacity = 100)
    {
        var options = new BoundedChannelOptions(capacity)
        {
            FullMode = BoundedChannelFullMode.Wait
        };
        _queue = Channel.CreateBounded<(string, string, string)>(options);
    }
}
```

### 3. Background Services (Ø¨Ø§ IServiceScopeFactory)

#### BackgroundSmsService:
```csharp
public class BackgroundSmsService : BackgroundService
{
    private readonly IBackgroundSmsQueue _smsQueue;
    private readonly IServiceScopeFactory _serviceScopeFactory;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var (smsText, phones) = await _smsQueue.DequeueAsync(stoppingToken);
            
            // âœ… Ø§ÛŒØ¬Ø§Ø¯ scope Ø¨Ø±Ø§ÛŒ Ù‡Ø± SMS
            using (var scope = _serviceScopeFactory.CreateScope())
            {
                var smsService = scope.ServiceProvider.GetRequiredService<ISmsService>();
                await smsService.SendSms(smsText, phones);
            }
        }
    }
}
```

#### BackgroundEmailService:
```csharp
public class BackgroundEmailService : BackgroundService
{
    private readonly IBackgroundEmailQueue _emailQueue;
    private readonly IServiceScopeFactory _serviceScopeFactory;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            var (email, subject, htmlMessage) = await _emailQueue.DequeueAsync(stoppingToken);
            
            // âœ… Ø§ÛŒØ¬Ø§Ø¯ scope Ø¨Ø±Ø§ÛŒ Ù‡Ø± Email
            using (var scope = _serviceScopeFactory.CreateScope())
            {
                var emailSender = scope.ServiceProvider.GetRequiredService<IEmailSender>();
                await emailSender.SendEmailAsync(email, subject, htmlMessage);
            }
        }
    }
}
```

**ğŸ”‘ Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…**: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² `IServiceScopeFactory` Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø§ÛŒÙ†Ú©Ù‡ `BackgroundService` ÛŒÚ© **Singleton** Ø§Ø³Øª Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ **Scoped** Ø±Ø§ inject Ú©Ù†Ø¯.

---

## ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡

### 1. SMS Queue Files

#### `Services/BackgroundSmsQueue.cs`
```csharp
using System;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace IdentityCoreCustomization.Services
{
    public interface IBackgroundSmsQueue
    {
        void QueueSms(string smsText, string receipentPhone);
        void QueueSms(string smsText, List<string> receipentPhones);
        Task<(string SmsText, List<string> Phones)> DequeueAsync(CancellationToken cancellationToken);
    }

    public class BackgroundSmsQueue : IBackgroundSmsQueue
    {
        private readonly Channel<(string SmsText, List<string> Phones)> _queue;

        public BackgroundSmsQueue(int capacity = 100)
        {
            var options = new BoundedChannelOptions(capacity)
            {
                FullMode = BoundedChannelFullMode.Wait
            };
            _queue = Channel.CreateBounded<(string, List<string>)>(options);
        }

        public void QueueSms(string smsText, string receipentPhone)
        {
            ArgumentNullException.ThrowIfNull(smsText);
            ArgumentNullException.ThrowIfNull(receipentPhone);
            _queue.Writer.TryWrite((smsText, new List<string> { receipentPhone }));
        }

        public void QueueSms(string smsText, List<string> receipentPhones)
        {
            ArgumentNullException.ThrowIfNull(smsText);
            ArgumentNullException.ThrowIfNull(receipentPhones);
            _queue.Writer.TryWrite((smsText, receipentPhones));
        }

        public async Task<(string SmsText, List<string> Phones)> DequeueAsync(CancellationToken cancellationToken)
        {
            return await _queue.Reader.ReadAsync(cancellationToken);
        }
    }
}
```

#### `Services/BackgroundSmsService.cs`
```csharp
using System;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace IdentityCoreCustomization.Services
{
    public class BackgroundSmsService : BackgroundService
    {
        private readonly IBackgroundSmsQueue _smsQueue;
        private readonly IServiceScopeFactory _serviceScopeFactory;
        private readonly ILogger<BackgroundSmsService> _logger;

        public BackgroundSmsService(
            IBackgroundSmsQueue smsQueue,
            IServiceScopeFactory serviceScopeFactory,
            ILogger<BackgroundSmsService> logger)
        {
            _smsQueue = smsQueue;
            _serviceScopeFactory = serviceScopeFactory;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("Background SMS Service started.");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    var (smsText, phones) = await _smsQueue.DequeueAsync(stoppingToken);
                    _logger.LogInformation("Sending SMS to {Count} recipient(s)", phones.Count);

                    using (var scope = _serviceScopeFactory.CreateScope())
                    {
                        var smsService = scope.ServiceProvider.GetRequiredService<ISmsService>();
                        await smsService.SendSms(smsText, phones);
                    }

                    _logger.LogInformation("SMS sent successfully to {Count} recipient(s)", phones.Count);
                }
                catch (OperationCanceledException)
                {
                    break;
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error occurred while sending SMS");
                }
            }

            _logger.LogInformation("Background SMS Service stopped.");
        }
    }
}
```

### 2. Email Queue Files

#### `Services/BackgroundEmailQueue.cs`
```csharp
using System;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace IdentityCoreCustomization.Services
{
    public interface IBackgroundEmailQueue
    {
        void QueueEmail(string email, string subject, string htmlMessage);
        Task<(string Email, string Subject, string HtmlMessage)> DequeueAsync(CancellationToken cancellationToken);
    }

    public class BackgroundEmailQueue : IBackgroundEmailQueue
    {
        private readonly Channel<(string Email, string Subject, string HtmlMessage)> _queue;

        public BackgroundEmailQueue(int capacity = 100)
        {
            var options = new BoundedChannelOptions(capacity)
            {
                FullMode = BoundedChannelFullMode.Wait
            };
            _queue = Channel.CreateBounded<(string, string, string)>(options);
        }

        public void QueueEmail(string email, string subject, string htmlMessage)
        {
            ArgumentNullException.ThrowIfNull(email);
            ArgumentNullException.ThrowIfNull(subject);
            ArgumentNullException.ThrowIfNull(htmlMessage);
            _queue.Writer.TryWrite((email, subject, htmlMessage));
        }

        public async Task<(string Email, string Subject, string HtmlMessage)> DequeueAsync(CancellationToken cancellationToken)
        {
            return await _queue.Reader.ReadAsync(cancellationToken);
        }
    }
}
```

#### `Services/BackgroundEmailService.cs`
```csharp
using System;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity.UI.Services;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace IdentityCoreCustomization.Services
{
    public class BackgroundEmailService : BackgroundService
    {
        private readonly IBackgroundEmailQueue _emailQueue;
        private readonly IServiceScopeFactory _serviceScopeFactory;
        private readonly ILogger<BackgroundEmailService> _logger;

        public BackgroundEmailService(
            IBackgroundEmailQueue emailQueue,
            IServiceScopeFactory serviceScopeFactory,
            ILogger<BackgroundEmailService> logger)
        {
            _emailQueue = emailQueue;
            _serviceScopeFactory = serviceScopeFactory;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("Background Email Service started.");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    var (email, subject, htmlMessage) = await _emailQueue.DequeueAsync(stoppingToken);
                    _logger.LogInformation("Sending email to {Email} with subject '{Subject}'", email, subject);

                    using (var scope = _serviceScopeFactory.CreateScope())
                    {
                        var emailSender = scope.ServiceProvider.GetRequiredService<IEmailSender>();
                        await emailSender.SendEmailAsync(email, subject, htmlMessage);
                    }

                    _logger.LogInformation("Email sent successfully to {Email}", email);
                }
                catch (OperationCanceledException)
                {
                    break;
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error occurred while sending email");
                }
            }

            _logger.LogInformation("Background Email Service stopped.");
        }
    }
}
```

---

## ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡

### 1. ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± `Program.cs`

```csharp
// Email Services
builder.Services.Configure<EmailOptions>(builder.Configuration.GetSection("Email"));
services.AddTransient<IEmailSender, EmailSender>();

// âœ¨ Background Email Queue
services.AddSingleton<IBackgroundEmailQueue, BackgroundEmailQueue>();
services.AddHostedService<BackgroundEmailService>();

// SMS Services
services.AddScoped<ISmsService, SmsService>();

// âœ¨ Background SMS Queue
services.AddSingleton<IBackgroundSmsQueue, BackgroundSmsQueue>();
services.AddHostedService<BackgroundSmsService>();
```

**Service Lifetimes:**
- `IBackgroundSmsQueue` & `IBackgroundEmailQueue`: **Singleton** (Ù…Ø´ØªØ±Ú© Ø¨Ø±Ø§ÛŒ Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡)
- `BackgroundSmsService` & `BackgroundEmailService`: **HostedService** (Ø®ÙˆØ¯Ú©Ø§Ø±)
- `ISmsService`: **Scoped** (Ù‡Ø± scope Ø¬Ø¯ÛŒØ¯)
- `IEmailSender`: **Transient** (Ù‡Ø± request Ø¬Ø¯ÛŒØ¯)

### 2. ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± `AccountController.cs`

#### Constructor:
```csharp
public AccountController(
    // ...
    IEmailSender emailSender,
    IBackgroundEmailQueue emailQueue,  // âœ¨ Ø¬Ø¯ÛŒØ¯
    IBackgroundSmsQueue smsQueue        // âœ¨ Ø¬Ø¯ÛŒØ¯
)
{
    _emailSender = emailSender;
    _emailQueue = emailQueue;    // âœ¨ Ø¬Ø¯ÛŒØ¯
    _smsQueue = smsQueue;         // âœ¨ Ø¬Ø¯ÛŒØ¯
}
```

#### Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Actionâ€ŒÙ‡Ø§:

**ForgotPassword:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await _emailSender.SendEmailAsync(model.Email, "Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ú©Ù„Ù…Ù‡ Ø¹Ø¨ÙˆØ±", body);

// âœ… Ø¨Ø¹Ø¯:
_emailQueue.QueueEmail(model.Email, "Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ú©Ù„Ù…Ù‡ Ø¹Ø¨ÙˆØ±", body);
```

**Register:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await _emailSender.SendEmailAsync(model.Email, "Confirm your email", body);

// âœ… Ø¨Ø¹Ø¯:
_emailQueue.QueueEmail(model.Email, "Confirm your email", body);
```

**ResendEmailConfirmation:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await _emailSender.SendEmailAsync(model.Email, "ØªØ§ÛŒÛŒØ¯ Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§", body);

// âœ… Ø¨Ø¹Ø¯:
_emailQueue.QueueEmail(model.Email, "ØªØ§ÛŒÛŒØ¯ Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§", body);
```

**Login (2FA SMS):**
```csharp
// âŒ Ù‚Ø¨Ù„:
await smsService.SendSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {token.AuthenticationCode}", user.PhoneNumber);

// âœ… Ø¨Ø¹Ø¯:
_smsQueue.QueueSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {token.AuthenticationCode}", user.PhoneNumber);
```

**LoginWithSms:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await smsService.SendSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {code}", phone);

// âœ… Ø¨Ø¹Ø¯:
_smsQueue.QueueSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {code}", phone);
```

**PreRegister:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await smsService.SendSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {model.AuthenticationCode}", model.PhoneNumber);

// âœ… Ø¨Ø¹Ø¯:
_smsQueue.QueueSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {model.AuthenticationCode}", model.PhoneNumber);
```

### 3. ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± `ManageController.cs`

#### Constructor:
```csharp
public ManageController(
    // ...
    IEmailSender emailSender,
    IBackgroundEmailQueue emailQueue,  // âœ¨ Ø¬Ø¯ÛŒØ¯
    IBackgroundSmsQueue smsQueue       // âœ¨ Ø¬Ø¯ÛŒØ¯
)
{
    _emailSender = emailSender;
    _emailQueue = emailQueue;    // âœ¨ Ø¬Ø¯ÛŒØ¯
    _smsQueue = smsQueue;         // âœ¨ Ø¬Ø¯ÛŒØ¯
}
```

#### Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Actionâ€ŒÙ‡Ø§:

**Email (Change Email):**
```csharp
// âŒ Ù‚Ø¨Ù„:
await _emailSender.SendEmailAsync(model.NewEmail, "Confirm your email", body);

// âœ… Ø¨Ø¹Ø¯:
_emailQueue.QueueEmail(model.NewEmail, "Confirm your email", body);
```

**SendVerificationEmail:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await _emailSender.SendEmailAsync(email, "Confirm your email", body);

// âœ… Ø¨Ø¹Ø¯:
_emailQueue.QueueEmail(email, "Confirm your email", body);
```

**AddPhoneNumber:**
```csharp
// âŒ Ù‚Ø¨Ù„:
await smsService.SendSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {phoneTokenModel.AuthenticationCode}", model.PhoneNumber);

// âœ… Ø¨Ø¹Ø¯:
_smsQueue.QueueSms($"Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§: {phoneTokenModel.AuthenticationCode}", model.PhoneNumber);
```

---

## Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡

### 1. Ø§Ø±Ø³Ø§Ù„ SMS

```csharp
// ØªÚ©â€ŒÙ†ÙØ±Ù‡
_smsQueue.QueueSms("Ù…ØªÙ† Ù¾ÛŒØ§Ù…Ú©", "09123456789");

// Ú†Ù†Ø¯Ù†ÙØ±Ù‡
var phones = new List<string> { "09123456789", "09187654321" };
_smsQueue.QueueSms("Ù…ØªÙ† Ù¾ÛŒØ§Ù…Ú©", phones);
```

### 2. Ø§Ø±Ø³Ø§Ù„ Email

```csharp
_emailQueue.QueueEmail(
    "user@example.com",
    "Ø¹Ù†ÙˆØ§Ù† Ø§ÛŒÙ…ÛŒÙ„",
    "<p>Ù…Ø­ØªÙˆØ§ÛŒ HTML Ø§ÛŒÙ…ÛŒÙ„</p>"
);
```

### 3. âœ… Ø¨Ø¯ÙˆÙ† await

```csharp
// âŒ Ø§Ø´ØªØ¨Ø§Ù‡ - Ù†Ø¨Ø§ÛŒØ¯ await Ú©Ø±Ø¯
await _smsQueue.QueueSms(...);
await _emailQueue.QueueEmail(...);

// âœ… Ø¯Ø±Ø³Øª - ÙÙˆØ±ÛŒ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯
_smsQueue.QueueSms(...);
_emailQueue.QueueEmail(...);
return RedirectToAction("NextPage");
